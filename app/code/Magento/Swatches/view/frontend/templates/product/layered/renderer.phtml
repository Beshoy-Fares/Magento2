<?php
/**
 * Copyright Â© Magento, Inc. All rights reserved.
 * See COPYING.txt for license details.
 */

use Magento\Framework\Escaper;
use Magento\Framework\View\Helper\SecureHtmlRenderer;
use Magento\Swatches\Block\LayeredNavigation\RenderLayered;
use Magento\Swatches\ViewModel\Product\Renderer\Configurable as ConfigurableViewModel;

// phpcs:disable PSR2.ControlStructures.SwitchDeclaration
// phpcs:disable Generic.WhiteSpace.ScopeIndent

/** @var RenderLayered $block */
/** @var SecureHtmlRenderer $secureRenderer */
/** @var Escaper $escaper */
?>
<?php $swatchData = $block->getSwatchData(); ?>
<?php /** @var ConfigurableViewModel $configurableViewModel */ ?>
<?php $configurableViewModel = $block->getConfigurableViewModel() ?>
<div class="swatch-attribute swatch-layered <?= $escaper->escapeHtmlAttr($swatchData['attribute_code']) ?>"
     data-attribute-code="<?= $escaper->escapeHtmlAttr($swatchData['attribute_code']) ?>"
     data-attribute-id="<?= $escaper->escapeHtmlAttr($swatchData['attribute_id']) ?>">
    <div class="swatch-attribute-options clearfix">
        <?php foreach ($swatchData['options'] as $option => $label): ?>
            <a href="<?= $escaper->escapeUrl($label['link']) ?>" rel="nofollow"
               aria-label="<?= $escaper->escapeHtmlAttr($label['label']) ?>"
               class="swatch-option-link-layered">
                <?php if (isset($swatchData['swatches'][$option]['type'])): ?>
                    <?php switch ($swatchData['swatches'][$option]['type']) {
                        case '3':
                            ?>
                            <div class="swatch-option <?= $escaper->escapeHtmlAttr($label['custom_style']) ?>"
                                 tabindex="-1"
                                 data-option-type="3"
                                 data-option-id="<?= $escaper->escapeHtmlAttr($option) ?>"
                                 data-option-label="<?= $escaper->escapeHtmlAttr($label['label']) ?>"
                                 data-option-tooltip-thumb=""
                                 data-option-tooltip-value=""
                                ></div>
                            <?php break;
                        case '2':
                            ?>
                            <?php $swatchThumbPath = $block->getSwatchPath(
                                'swatch_thumb',
                                $swatchData['swatches'][$option]['value']
                            ); ?>
                            <?php $swatchImagePath = $block->getSwatchPath(
                                'swatch_image',
                                $swatchData['swatches'][$option]['value']
                            );
                            $escapedUrl = $escaper->escapeUrl($swatchImagePath);
                            ?>
                            <div class="swatch-option image <?= $escaper->escapeHtmlAttr($label['custom_style']) ?>"
                                 tabindex="-1"
                                 data-option-type="2"
                                 data-option-id="<?= $escaper->escapeHtmlAttr($option) ?>"
                                 data-option-label="<?= $escaper->escapeHtmlAttr($label['label']) ?>"
                                 data-option-tooltip-thumb="<?= $escaper->escapeUrl($swatchThumbPath) ?>"
                                 data-option-tooltip-value="">
                            </div>
                            <?php
                            $element = 'swatchImageOption' . $escaper->escapeJs($option);
                            $script = 'var ' . $element
                                . ' = document.querySelector(\'div[data-option-id="' . $escaper->escapeJs($option)
                                . '"]\');' . PHP_EOL;
                            $script .= $element . '.style.background = "url(\''
                                . $escapedUrl . '\') no-repeat center";' . PHP_EOL;
                            $script .= $element . '.style.backgroundSize = "initial";';
                            ?>
                            <?= /* @noEscape*/ $secureRenderer->renderTag('script', [], $script, false) ?>
                            <?php break;
                        case '1':
                            ?>
                            <div class="swatch-option color <?= $escaper->escapeHtmlAttr($label['custom_style']) ?>"
                                 tabindex="-1"
                                 data-option-type="1"
                                 data-option-id="<?= $escaper->escapeHtmlAttr($option) ?>"
                                 data-option-label="<?= $escaper->escapeHtmlAttr($label['label']) ?>"
                                 data-option-tooltip-thumb=""
                                 data-option-tooltip-value="<?= $escaper->escapeHtmlAttr(
                                     $swatchData['swatches'][$option]['value']
                                 ) ?>">
                            </div>
                            <?php
                            $element = 'swatchImageOption' . $escaper->escapeJs($option);
                            $backgroundValue = $escaper->escapeJs(
                                str_replace('\'', '\\\'', $swatchData['swatches'][$option]['value'])
                            );
                            $script = 'var ' . $element
                                . ' = document.querySelector(\'div[data-option-id="' . $escaper->escapeJs($option)
                                . '"]\');' . PHP_EOL;
                            $script .= $element . '.style.background = "' . $backgroundValue
                                . ' no-repeat center";' . PHP_EOL;
                            $script .= $element . '.style.backgroundSize = "initial";';
                            ?>
                            <?= /* @noEscape*/ $secureRenderer->renderTag('script', [], $script, false) ?>
                            <?php break;
                        case '0':
                        default:
                            ?>
                            <div class="swatch-option text <?= $escaper->escapeHtmlAttr($label['custom_style']) ?>"
                                 tabindex="-1"
                                 data-option-type="0"
                                 data-option-id="<?= $escaper->escapeHtmlAttr($option) ?>"
                                 data-option-label="<?= $escaper->escapeHtmlAttr($label['label']) ?>"
                                 data-option-tooltip-thumb=""
                                 data-option-tooltip-value=""
                                ><?= $escaper->escapeHtml($swatchData['swatches'][$option]['value']) ?></div>
                        <?php break;
                    } ?>
                <?php endif; ?>
            </a>
        <?php endforeach; ?>
    </div>
</div>
<script type="text/x-magento-init">
    {
        ".swatch-layered.<?= $escaper->escapeJs($swatchData['attribute_code']) ?>": {
            "Magento_Swatches/js/layered/swatch-renderer": {
                "showTooltip": <?= $escaper->escapeJs($configurableViewModel->getShowSwatchTooltip()) ?>
            }
        }
    }
</script>
